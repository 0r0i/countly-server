<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>parts/mgmt/app_users.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Channel.html">Channel</a></li><li><a href="DefaultRetryPolicy.html">DefaultRetryPolicy</a></li><li><a href="IPCJob.html">IPCJob</a></li><li><a href="IPCRetryPolicy.html">IPCRetryPolicy</a></li><li><a href="Job.html">Job</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Job.html#cancel">cancel</a></li><li data-type='method' style='display: none;'><a href="Job.html#divide">divide</a></li><li data-type='method' style='display: none;'><a href="Job.html#getConcurrency">getConcurrency</a></li><li data-type='method' style='display: none;'><a href="Job.html#prepare">prepare</a></li><li data-type='method' style='display: none;'><a href="Job.html#retryPolicy">retryPolicy</a></li><li data-type='method' style='display: none;'><a href="Job.html#run">run</a></li></ul></li><li><a href="Manager.html">Manager</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Manager.html#run">run</a></li><li data-type='method' style='display: none;'><a href="Manager.html#runIPC">runIPC</a></li><li data-type='method' style='display: none;'><a href="Manager.html#runLocally">runLocally</a></li></ul></li><li><a href="module-api_lib_countly.model-countlyMetric.html">countlyMetric</a><ul class='members'><li data-type='member' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.fetchValue">countlyMetric.fetchValue</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.clearObject">countlyMetric.clearObject</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.extendDb">countlyMetric.extendDb</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.getBars">countlyMetric.getBars</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.getData">countlyMetric.getData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.getDb">countlyMetric.getDb</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.getMeta">countlyMetric.getMeta</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.getMetrics">countlyMetric.getMetrics</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.getNumber">countlyMetric.getNumber</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.getRangeData">countlyMetric.getRangeData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.getTableData">countlyMetric.getTableData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.getTimelineData">countlyMetric.getTimelineData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.getTotalUsersObj">countlyMetric.getTotalUsersObj</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.getUniqueMetrics">countlyMetric.getUniqueMetrics</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.reset">countlyMetric.reset</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.setDb">countlyMetric.setDb</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.setMetrics">countlyMetric.setMetrics</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.setTotalUsersObj">countlyMetric.setTotalUsersObj</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.setUniqueMetrics">countlyMetric.setUniqueMetrics</a></li></ul></li><li><a href="module-api_utils_log-Logger.html">Logger</a><ul class='members'><li data-type='member' style='display: none;'><a href="module-api_utils_log-Logger.html#.d">d</a></li><li data-type='member' style='display: none;'><a href="module-api_utils_log-Logger.html#.e">e</a></li><li data-type='member' style='display: none;'><a href="module-api_utils_log-Logger.html#.i">i</a></li><li data-type='member' style='display: none;'><a href="module-api_utils_log-Logger.html#.w">w</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_utils_log-Logger.html#.callback">callback</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_log-Logger.html#.logdb">logdb</a></li></ul></li><li><a href="NoRetryPolicy.html">NoRetryPolicy</a></li><li><a href="Resource.html">Resource</a></li><li><a href="ResourceFa%25C3%25A7ade.html">ResourceFa√ßade</a></li><li><a href="ResourcefulJob.html">ResourcefulJob</a></li><li><a href="ResourceInterface.html">ResourceInterface</a></li></ul><h3>Modules</h3><ul><li><a href="module-api_lib_countly.common.html">api/lib/countly.common</a><ul class='members'><li data-type='member' style='display: none;'><a href="module-api_lib_countly.common.html#.periodObj">periodObj</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.decode">decode</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.decodeHtml">decodeHtml</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.encode">encode</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.extractBarData">extractBarData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.extractChartData">extractChartData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.extractData">extractData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.extractMetric">extractMetric</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.extractRangeData">extractRangeData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.extractTwoLevelData">extractTwoLevelData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.getDashboardData">getDashboardData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.getDateRange">getDateRange</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.getDescendantProp">getDescendantProp</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.getPercentChange">getPercentChange</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.getPeriodObj">getPeriodObj</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.getShortNumber">getShortNumber</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.getSparklineData">getSparklineData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.getTimestampRangeQuery">getTimestampRangeQuery</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.mergeMetricsByName">mergeMetricsByName</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.setPeriod">setPeriod</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.setTimezone">setTimezone</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.timeString">timeString</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.union">union</a></li></ul></li><li><a href="module-api_lib_countly.countries.html">api/lib/countly.countries</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_lib_countly.countries.html#.getLocationData">getLocationData</a></li></ul></li><li><a href="module-api_lib_countly.device_details.html">api/lib/countly.device_details</a></li><li><a href="module-api_lib_countly.devices.html">api/lib/countly.devices</a></li><li><a href="module-api_lib_countly.event.html">api/lib/countly.event</a></li><li><a href="module-api_lib_countly.model.html">api/lib/countly.model</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model.html#.create">create</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model.html#.load">load</a></li></ul></li><li><a href="module-api_lib_countly.users.html">api/lib/countly.users</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_lib_countly.users.html#.getSessionData">getSessionData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.users.html#.getSubperiodData">getSubperiodData</a></li></ul></li><li><a href="module-api_config.html">api/config</a><ul class='members'><li data-type='member' style='display: none;'><a href="module-api_config.html#.api">api</a></li><li data-type='member' style='display: none;'><a href="module-api_config.html#.api">api</a></li><li data-type='member' style='display: none;'><a href="module-api_config.html#.encryption">encryption</a></li><li data-type='member' style='display: none;'><a href="module-api_config.html#.encryption">encryption</a></li><li data-type='member' style='display: none;'><a href="module-api_config.html#.fileStorage">fileStorage</a></li><li data-type='member' style='display: none;'><a href="module-api_config.html#.fileStorage">fileStorage</a></li><li data-type='member' style='display: none;'><a href="module-api_config.html#.ignoreProxies">ignoreProxies</a></li><li data-type='member' style='display: none;'><a href="module-api_config.html#.ignoreProxies">ignoreProxies</a></li><li data-type='member' style='display: none;'><a href="module-api_config.html#.logging">logging</a></li><li data-type='member' style='display: none;'><a href="module-api_config.html#.logging">logging</a></li><li data-type='member' style='display: none;'><a href="module-api_config.html#.mongodb">mongodb</a></li><li data-type='member' style='display: none;'><a href="module-api_config.html#.mongodb">mongodb</a></li><li data-type='member' style='display: none;'><a href="module-api_config.html#.path">path</a></li><li data-type='member' style='display: none;'><a href="module-api_config.html#.path">path</a></li></ul></li><li><a href="module-api_parts_data_exports.html">api/parts/data/exports</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_parts_data_exports.html#.convertData">convertData</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_exports.html#.fromData">fromData</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_exports.html#.fromDatabase">fromDatabase</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_exports.html#.fromRequest">fromRequest</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_exports.html#.output">output</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_exports.html#.stream">stream</a></li></ul></li><li><a href="module-api_parts_data_fetch.html">api/parts/data/fetch</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#.getMergedEventData">getMergedEventData</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#.getMetric">getMetric</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#.getTimeObj">getTimeObj</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#.getTimeObjForEvents">getTimeObjForEvents</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#.getTotalUsersObj">getTotalUsersObj</a></li></ul></li><li><a href="module-api_parts_mgmt_app_users.html">api/parts/mgmt/app_users</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_app_users.html#.count">count</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_app_users.html#.create">create</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_app_users.html#.delete">delete</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_app_users.html#.export">export</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_app_users.html#.getUid">getUid</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_app_users.html#.merge">merge</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_app_users.html#.search">search</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_app_users.html#.update">update</a></li></ul></li><li><a href="module-api_utils_authorizer.html">api/utils/authorizer</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_utils_authorizer.html#.clean">clean</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_authorizer.html#.getToken">getToken</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_authorizer.html#.read">read</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_authorizer.html#.save">save</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_authorizer.html#.verify">verify</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_authorizer.html#.verify_return">verify_return</a></li></ul></li><li><a href="module-api_utils_common.html">api/utils/common</a><ul class='members'><li data-type='member' style='display: none;'><a href="module-api_utils_common.html#.base64">base64</a></li><li data-type='member' style='display: none;'><a href="module-api_utils_common.html#.config">config</a></li><li data-type='member' style='display: none;'><a href="module-api_utils_common.html#.crypto">crypto</a></li><li data-type='member' style='display: none;'><a href="module-api_utils_common.html#.dbEventMap">dbEventMap</a></li><li data-type='member' style='display: none;'><a href="module-api_utils_common.html#.dbMap">dbMap</a></li><li data-type='member' style='display: none;'><a href="module-api_utils_common.html#.dbUserMap">dbUserMap</a></li><li data-type='member' style='display: none;'><a href="module-api_utils_common.html#.log">log</a></li><li data-type='member' style='display: none;'><a href="module-api_utils_common.html#.moment">moment</a></li><li data-type='member' style='display: none;'><a href="module-api_utils_common.html#.os_mapping">os_mapping</a></li><li data-type='member' style='display: none;'><a href="module-api_utils_common.html#.time">time</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.adjustTimestampByTimezone">adjustTimestampByTimezone</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.arrayAddUniq">arrayAddUniq</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.blockResponses">blockResponses</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.checkPromise">checkPromise</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.convertToType">convertToType</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.dot">dot</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.fillTimeObject">fillTimeObject</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.fillTimeObjectMonth">fillTimeObjectMonth</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.fillTimeObjectZero">fillTimeObjectZero</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.fixEventKey">fixEventKey</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.getDate">getDate</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.getDateIds">getDateIds</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.getDaysInYear">getDaysInYear</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.getDescendantProp">getDescendantProp</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.getDiff">getDiff</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.getDOY">getDOY</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.getIpAddress">getIpAddress</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.getISOWeeksInYear">getISOWeeksInYear</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.indexOf">indexOf</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.initTimeObj">initTimeObj</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.isNumber">isNumber</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.md5Hash">md5Hash</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.o">o</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.optional">optional</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.parseSequence">parseSequence</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.processCarrier">processCarrier</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.recordCustomMetric">recordCustomMetric</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.recordMetric">recordMetric</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.returnMessage">returnMessage</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.returnOutput">returnOutput</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.returnRaw">returnRaw</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.reviver">reviver</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.safeDivision">safeDivision</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.sha1Hash">sha1Hash</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.sha512Hash">sha512Hash</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.unblockResponses">unblockResponses</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.updateAppUser">updateAppUser</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.validateArgs">validateArgs</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.versionCompare">versionCompare</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.zeroFill">zeroFill</a></li></ul></li><li><a href="module-api_utils_countlyFs.html">api/utils/countlyFs</a><ul class='members'><li data-type='member' style='display: none;'><a href="module-api_utils_countlyFs.html#.fs">fs</a></li><li data-type='member' style='display: none;'><a href="module-api_utils_countlyFs.html#.gridfs">gridfs</a></li><li data-type='member' style='display: none;'><a href="module-api_utils_countlyFs.html#.type">type</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_utils_countlyFs.html#.deleteFile">deleteFile</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_countlyFs.html#.exists">exists</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_countlyFs.html#.getData">getData</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_countlyFs.html#.getHandler">getHandler</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_countlyFs.html#.getSize">getSize</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_countlyFs.html#.getStats">getStats</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_countlyFs.html#.getStream">getStream</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_countlyFs.html#.rename">rename</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_countlyFs.html#.saveData">saveData</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_countlyFs.html#.saveFile">saveFile</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_countlyFs.html#.saveStream">saveStream</a></li></ul></li><li><a href="module-api_utils_localization.html">api/utils/localization</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_utils_localization.html#.format">format</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_localization.html#.getProperties">getProperties</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_localization.html#.getProperty">getProperty</a></li></ul></li><li><a href="module-api_utils_log.html">api/utils/log</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_utils_log.html#.getLevel">getLevel</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_log.html#.ipcHandler">ipcHandler</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_log.html#.setDefault">setDefault</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_log.html#.setLevel">setLevel</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_log.html#~log">log</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_log.html#~logLevel">logLevel</a></li></ul></li><li><a href="module-api_utils_requestProcessor.html">api/utils/requestProcessor</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_utils_requestProcessor.html#.processRequest">processRequest</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_requestProcessor.html#~continueProcessingRequestData">continueProcessingRequestData</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_requestProcessor.html#~processBulkRequest">processBulkRequest</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_requestProcessor.html#~processRequestData">processRequestData</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_requestProcessor.html#~restartRequest">restartRequest</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_requestProcessor.html#~validateAppForWriteAPI">validateAppForWriteAPI</a></li></ul></li><li><a href="module-api_utils_rights.html">api/utils/rights</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_utils_rights.html#.validateGlobalAdmin">validateGlobalAdmin</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_rights.html#.validateUser">validateUser</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_rights.html#.validateUserForRead">validateUserForRead</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_rights.html#.validateUserForWrite">validateUserForWrite</a></li></ul></li><li><a href="module-api_utils_taskmanager.html">api/utils/taskmanager</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.checkIfRunning">checkIfRunning</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.checkResult">checkResult</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.createTask">createTask</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.deleteResult">deleteResult</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.errorResults">errorResults</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.getId">getId</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.getResult">getResult</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.getResults">getResults</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.longtask">longtask</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.nameResult">nameResult</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.rerunTask">rerunTask</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.saveResult">saveResult</a></li></ul></li><li><a href="module-api_utils_utils.html">api/utils/utils</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_utils_utils.html#.decrypt">decrypt</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_utils.html#.encrypt">encrypt</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#APICallback">APICallback</a></li><li><a href="global.html#debounce">debounce</a></li><li><a href="global.html#IPC">IPC</a></li><li><a href="global.html#params">params</a></li><li><a href="global.html#passToMaster">passToMaster</a></li><li><a href="global.html#timeObject">timeObject</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">parts/mgmt/app_users.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
* This module is meant for manipulating app_users documents programmatically, without the need of SDK request
* @module api/parts/mgmt/app_users
*/

/** @lends module:api/parts/mgmt/app_users */
var usersApi = {},
    common = require('./../../utils/common.js'),
	plugins = require('../../../plugins/pluginManager.js');
var path = require('path');
const fs = require('fs');
var countlyFs = require('./../../utils/countlyFs.js');
var cp = require('child_process'); //call process
var spawn = cp.spawn; //for calling comannd line
const fse = require('fs-extra');
var crypto = require('crypto');

(function (usersApi) {
    /**
    * Create new app_user document. Creates uid if one is not provided
    * @param {string} app_id - _id of the app
    * @param {object} doc - document to insert
    * @param {params} params - to determine who makes modification, should have member property with user who makes modification, and req for request object to determine ip address
    * @param {function} callback - called when finished providing error (if any) as first param and insert result as second
    */
    usersApi.create = function(app_id, doc, params, callback){
        if(typeof params === "function"){
            callback = params;
            params = {};
        }
        if(!doc){
            callback("Provide data to insert");
            return;
        }
        if(typeof doc.did === "undefined"){
            callback("Provide device_id as did property for data");
            return;
        }
        common.db.collection('apps').findOne({_id:common.db.ObjectID(app_id)}, function(err, app) {
            if(err || !app){
                callback("App does not exist");
                return;
            }
            var _id = common.crypto.createHash('sha1').update(app.key + doc.did + "").digest('hex');
            if(doc._id &amp;&amp; doc._id != _id){
                callback("Based on app key and device_id, provided _id property should be "+_id+". Do not provide _id if you want api to use correct one");
                return;
            }
            doc._id = _id;
            if(typeof doc.uid === "undefined"){
                usersApi.getUid(app_id, function(err1, uid){
                    if(uid){
                        doc.uid = uid;
                        common.db.collection('app_users' + app_id).insert(doc, function(err2, res) {
                            if(!err2){
                                plugins.dispatch("/i/app_users/create", {app_id:app_id, user:doc, res:doc, params:params});
                            }
                            if(callback)
                                callback(err1 || err2, doc);
                        });
                    }
                    else if(callback){
                        callback(err1);
                    }
                });
            }
            else{
                common.db.collection('app_users' + app_id).insert(doc, function(err, res) {
                    if(!err){
                        plugins.dispatch("/i/app_users/create", {app_id:app_id, user:doc, res:doc, params:params});
                    }
                    if(callback)
                        callback(err, doc);
                });
            }
        });
    };
    
    /**
    * Update existing app_users document. Cannot replace document, must have modifiers like $set, $unset, etc
    * @param {string} app_id - _id of the app
    * @param {object} query - mongodb query to select which app users to update
    * @param {object} update - mongodb update object
    * @param {params} params - to determine who makes modification, should have member property with user who makes modification, and req for request object to determine ip address
    * @param {function} callback - called when finished providing error (if any) as first param and updated user document as second
    */
    usersApi.update = function(app_id, query, update, params, callback){
        if(typeof params === "function"){
            callback = params;
            params = {};
        }
        if(Object.keys(update).length){
            for(var i in update){
                if(i.indexOf("$") !== 0){
                    var err = "Unkown modifier " + i + " in " + JSON.stringify(update) + " for " + JSON.stringify(query);
                    console.log(err);
                    if(callback)
                        callback(err);
                    return;
                }
            }
            common.db.collection('app_users' + app_id).findAndModify(query, {}, update, {upsert:true}, function(err, res) {
                if(!err){
                    plugins.dispatch("/i/app_users/update", {app_id:app_id, query:query, update:update, user:res &amp;&amp; res.value, params:params});
                }
                if(callback)
                    callback(err, res &amp;&amp; res.value);
            });
        }
        else if(callback)
            callback("Update can't be empty");
    };
    
    /**
    * Delete existing app_users documents, deletes also all plugin data
    * @param {string} app_id - _id of the app
    * @param {object} query - mongodb query to select which app users to delete
    * @param {params} params - to determine who makes modification, should have member property with user who makes modification, and req for request object to determine ip address
    * @param {function} callback - called when finished providing error (if any) as first param and array with uids of removed users as second
    */
    usersApi.delete = function(app_id, query, params, callback){
        if(typeof params === "function"){
            callback = params;
            params = {};
        }
        common.db.collection("app_users"+app_id).aggregate([
            {
                $match: query
            },
            {
                $group: {
                    _id: null,
                    uid: { $addToSet: '$uid' },
                    picture:{$addToSet: '$picture'},
                    exported:{$addToSet:'$appUserExport'}
                }
            }
        ], {allowDiskUse:true}, function(err, res){
            if(res &amp;&amp; res[0] &amp;&amp; res[0].uid &amp;&amp; res[0].uid.length){
                common.db.collection("metric_changes" +  app_id).remove({uid: {$in: res[0].uid}},function(err, result){
                    plugins.dispatch("/i/app_users/delete", {app_id:app_id, query:query, uids:res[0].uid, params:params}, function(){
                        common.db.collection("app_users" + app_id).remove({uid: {$in: res[0].uid}},function(err, result){
                            if(res[0].exported)
                            {
                                for(var i=0;i&lt;res[0].exported.length; i++)//delete exports if exist
                                {
                                    var id = res[0].exported[i].split("/");
                                    id = id.substr(id.length-7);
                                    
                                    deleteMyExport(id).then(
                                        function(res){},
                                        function(err){ console.log(err);}
                                    );
                                }
                            }
                            //deleting userimages(if they exist);
                            if(res[0].picure)
                            {
                            for(var i=0;i&lt;res[0].picture.length; i++)//delete exports if exist
                                {
                                    //remove /userimages/ 
                                    var id = res[0].picture[i].substr(12,res[0].picture[i].length-12);
                                    var pp = path.resolve(__dirname,'./../../../frontend/express/public/userimages/'+id);
                                    countlyFs.deleteFile("userimages",pp,{id:id},function(err){
                                        if(err)
                                            console.log(err);
                                    }); 
                                }
                            }
                            try {
                              fs.appendFileSync(path.resolve(__dirname,'./../../../log/deletedUsers'+app_id+'.txt'), res[0].uid.join("\n")+"\n","utf-8");
                            } catch (err) {
                              console.log(err);
                            }
                            callback(err, res[0].uid);
                        });
                    });
                });
            }
            else{
                callback("No Users to delete", []);
            }
        });
    };
    
    /**
    * Search for users by query. Additionally can manipulate result set as sort, limit, skip, and specify return fields
    * @param {string} app_id - _id of the app
    * @param {object|json_string} query - mongodb query to select which app users to update
    * @param {object|json_string} project - mongodb projection which fields to return
    * @param {object|json_string} sort - mongodb sort object
    * @param {number} limit - upper limit, how many users to return
    * @param {number} skip - how many users to skip from beginning
    * @param {function} callback - called when finished providing error (if any) as first param and result user list array as second
    */
    usersApi.search = function(app_id, query, project, sort, limit, skip, callback){
        query = query || {};
        if(typeof query === "string" &amp;&amp; query.length){
            try{
                query = JSON.parse(query);
            }
            catch(ex){query = {};}
        }
        
        project = project || {};
        if(typeof project === "string" &amp;&amp; project.length){
            try{
                project = JSON.parse(project);
            }
            catch(ex){project = {};}
        }
        
        sort = sort || {};
        if(typeof sort === "string" &amp;&amp; sort.length){
            try{
                sort = JSON.parse(sort);
            }
            catch(ex){sort = {};}
        }
        
        limit = parseInt(limit) || 0;
        skip = parseInt(skip) || 0;
        
        var cursor =  common.db.collection('app_users' + app_id).find(query, project);
        if(Object.keys(sort).length){
            cursor.sort(sort);
        }
        
        if(skip){
            cursor.skip(skip);
        }
        
        if(limit){
            cursor.limit(limit);
        }
        
        cursor.toArray(callback);
    };
    
    /**
    * Count users by query. 
    * @param {string} app_id - _id of the app
    * @param {object|json_string} query - mongodb query to select which app users to update
    * @param {function} callback - called when finished providing error (if any) as first param and resultcount of users as second
    */
    usersApi.count = function(app_id, query, callback){
        query = query || {};
        if(typeof query === "string" &amp;&amp; query.length){
            try{
                query = JSON.parse(query);
            }
            catch(ex){query = {};}
        }
        
        common.db.collection('app_users' + app_id).count(query, callback);
    };
    
    /**
    * Returns uid for new users
    * @param {string} app_id - _id of the app
    * @param {function} callback - called when finished providing error (if any) as first param and new uid as second
    */
    usersApi.getUid = function(app_id, callback){
        common.db.collection('apps').findAndModify({_id:common.db.ObjectID(app_id)},{},{$inc:{seq:1}},{new:true, upsert:true}, function(err,result){
            result = result &amp;&amp; result.ok ? result.value : null;
            if (result &amp;&amp; result.seq) {
                if(callback)
                    callback(err, common.parseSequence(result.seq));
            }
            else if(callback){
                callback(err);
            }
        });
    }
    
    /**
    * Merges two app users data (including plugin data) into one user, using mostly params from latest user, and updates all collections
    * @param {string} app_id - _id of the app
    * @param {object} newAppUser - app_users document of new/current user
    * @param {string} new_id - new user's _id
    * @param {string} old_id - old user's _id
    * @param {string} new_device_id - new user's device_id
    * @param {string} old_device_id - old user's device_id
    * @param {function} callback - called when finished providing error (if any) as first param and resulting merged document as second
    */
    usersApi.merge = function(app_id, newAppUser, new_id, old_id, new_device_id, old_device_id, callback){
        function mergeUserData(newAppUser, oldAppUser){                  
            //allow plugins to deal with user mergin properties
            plugins.dispatch("/i/user_merge", {app_id:app_id, newAppUser:newAppUser, oldAppUser:oldAppUser});
            //merge user data
            for(var i in oldAppUser){
                // sum up session count and total session duration
                if(i == "sc" || i == "tsd"){
                    if(typeof newAppUser[i] === "undefined")
                        newAppUser[i] = 0;
                    newAppUser[i] += oldAppUser[i];
                }
                //check if old user has been seen before new one
                else if(i == "fs"){
                    if(!newAppUser.fs || oldAppUser.fs &lt; newAppUser.fs)
                        newAppUser.fs = oldAppUser.fs;
                }
               //check if old user has been seen before new one
                else if(i == "fac"){
                    if(!newAppUser.fac || oldAppUser.fac &lt; newAppUser.fac)
                        newAppUser.fac = oldAppUser.fac;
                }
                //check if old user has been the last to be seen
                else if(i == "ls"){
                    if(!newAppUser.ls || oldAppUser.ls > newAppUser.ls){
                        newAppUser.ls = oldAppUser.ls;
                        //then also overwrite last session data
                        if(oldAppUser.lsid)
                            newAppUser.lsid = oldAppUser.lsid;
                        if(oldAppUser.sd)
                            newAppUser.sd = oldAppUser.sd;
                    }
                }
                //check if old user has been the last to be seen
                else if(i == "lac"){
                    if(!newAppUser.lac || oldAppUser.lac > newAppUser.lac){
                        newAppUser.lac = oldAppUser.lac;
                    }
                }
                else if(i == "lest"){
                    if(!newAppUser.lest || oldAppUser.lest > newAppUser.lest){
                        newAppUser.lest = oldAppUser.lest;
                    }
                }
                else if(i == "lbst"){
                    if(!newAppUser.lbst || oldAppUser.lbst > newAppUser.lbst){
                        newAppUser.lbst = oldAppUser.lbst;
                    }
                }
                //merge custom user data
                else if(typeof oldAppUser[i] === "object" &amp;&amp; oldAppUser[i]){
                    if(typeof newAppUser[i] === "undefined")
                        newAppUser[i] = {};
                    for(var j in oldAppUser[i]){
                        //set properties that new user does not have
                        if(typeof newAppUser[i][j] === "undefined")
                            newAppUser[i][j] = oldAppUser[i][j];
                    }
                }
                //set other properties that new user does not have
                else if(i != "_id" &amp;&amp; i != "did" &amp;&amp; typeof newAppUser[i] === "undefined"){
                    newAppUser[i] = oldAppUser[i];
                }
            }
            //update new user
            common.db.collection('app_users' + app_id).update({_id:newAppUser._id}, {'$set': newAppUser}, function(){
                //delete old user
                common.db.collection('app_users' + app_id).remove({_id:oldAppUser._id}, function(err, res){
                    //let plugins know they need to merge user data
                    common.db.collection("metric_changes" + app_id).update({uid:oldAppUser.uid}, {'$set': {uid:newAppUser.uid}}, {multi:true}, function(err, res){});
                    plugins.dispatch("/i/device_id", {app_id:app_id, oldUser:oldAppUser, newUser:newAppUser});
                        if(callback)
                            callback(err, res);
                });
            });
        }

        common.db.collection('app_users' + app_id).findOne({'_id': old_id }, function (err, oldAppUser){
            if(!err &amp;&amp; oldAppUser){
                if(newAppUser &amp;&amp; Object.keys(newAppUser).length){
                    if(newAppUser.ls &amp;&amp; newAppUser.ls > oldAppUser.ls){
                        mergeUserData(newAppUser, oldAppUser);
                    }
                    else{
                        //switching user identity
                        var temp = oldAppUser._id;
                        oldAppUser._id = newAppUser._id;
                        newAppUser._id = temp;
                        
                        temp = oldAppUser.did;
                        oldAppUser.did = newAppUser.did;
                        newAppUser.did = temp;
                        
                        temp = oldAppUser.uid;
                        oldAppUser.uid = newAppUser.uid;
                        newAppUser.uid = temp;
                        
                        mergeUserData(oldAppUser, newAppUser);
                    }
                }
                else{
                    //simply copy user document with old uid
                    //no harm is done
                    oldAppUser.did = new_device_id + "";
                    oldAppUser._id = new_id;
                    common.db.collection('app_users' + app_id).insert(oldAppUser, function(){
                        common.db.collection('app_users' + app_id).remove({_id:old_id}, function(err, res){
                            if(callback)
                                callback(err, oldAppUser);
                        });
                    });
                }
            }
            else if(callback){
                //process request
                callback(null, newAppUser);
            }
        });
    };
    
   
    var deleteMyExport = function(exportID)
    {//tries to delete packed file, exported folder and saved export in gridfs
    //normally there should be only export in gridfs. Cleaning all to be sure.
    //rejects only if there stays any saved data for export
       return new Promise(function (resolve, reject) {
            //remove archive
            errors = [];
            if (fs.existsSync(path.resolve(__dirname,'./../../../export/AppUser/'+exportID+'.tar.gz'))) {
                try {fs.unlinkSync(path.resolve(__dirname,'./../../../export/AppUser/'+exportID+'.tar.gz'));}
                catch(err){ errors.push(err);}
            }
            
            countlyFs.gridfs.deleteFile("appUsers", path.resolve(__dirname,'./../../../export/AppUser/'+exportID+'.tar.gz'), {id:exportID+'.tar.gz'}, function(error)
            {
                if(error &amp;&amp; error.message &amp;&amp; error.message.substring(0,12)!="FileNotFound")
                    errors.push(error.message);
                if(fs.existsSync(path.resolve(__dirname,'./../../../export/AppUser/'+exportID)))
                {
                    fse.remove(path.resolve(__dirname,'./../../../export/AppUser/'+exportID),
                        err => { 
                            if(err)
                                errors.push(error);
                            if(errors.length==0)
                                resolve();
                            else
                                reject(errors);
                        }
                    );
                }
                else  
                {
                    if(errors.length==0)
                        resolve();
                    else
                        reject(errors);
                }
            });            
           
        });
    }
    
    usersApi.deleteExport=function(filename,params,callback)
    {
        if(filename &amp;&amp; filename!='')
        {
            var base_name = filename.split('.');
            var name_parts = base_name[0].split('_');
            
            //filename : appUsers_{appid}_{uid} vai appUsers_{appid}_HASH_{hash form uids}            
            if(name_parts[0] !='appUser')
            {
                callback('invalid filename','');
            }
            else
            {
                //remove archive
                deleteMyExport(base_name[0]).then(
                    function(res)
                    {
                        if(name_parts.length==3 &amp;&amp; name_parts[2]!='HASH')
                        {
                            //update user info
                            common.db.collection('app_users' + name_parts[1]).update({"uid":name_parts[2]},{$unset:{"appUserExport":""}}, {upsert:false}, function(err, res1) {
                                if(err)
                                    callback(err,"");
                                else
                                {
                                    plugins.dispatch("/systemlogs", {params:params, action:"export_app_user_deleted", data:{result:"ok",uids:name_parts[2],id:base_name[0],app_id:name_parts[1],info:"Exported data deleted"}});
                                    callback(null,"Export deleted");
                                }
                            });
                        }
                        else
                        {
                            plugins.dispatch("/systemlogs", {params:params, action:"export_app_user_deleted", data:{result:"ok",id:base_name[0],app_id:name_parts[1],info:"Exported data deleted"}});
                            callback(null,"Export deleted");
                        }
                    },
                    function(err)
                    {
                        console.log(err);
                        callback("There was some errors during deleting export. Please look in log for more information","");
                    }
                );             
            }
        }
        else
             callback("Invalid filename","");
    }
    
   var run_command = function(my_command)
    {
        return new Promise(function(resolve, reject){
            var child = spawn(my_command, {shell:true,cwd: path.resolve(__dirname,'./../../../export/AppUser'), detached:false},function(error)
            {
                if(error)
                {
                    return reject(Error('error:'+ JSON.stringify(error)));
                }
            });
            child.on('error', function(error) {
                console.log(error);
                return resolve();
            });
            child.on('exit', function(code) {
                if(code ==0)
                    return resolve();
                else
                    console.log("Exited with error code: "+code);
            });
        });
    }        
    var clear_out_empty_files = function(folder)
    {
        return new Promise(function(resolve, reject){
            run_command("find "+folder+" -type f -name '*.json' -size 0 -delete").then(
                function(result)
                {
                    resolve();
                },
                function(error)
                {
                    resolve(); //resolve anyway(not so bad if empty files not deleted)
                }
            );
        });
    }
     /**
    * Exports data about app_users, including plugin data
    * @param {string} app_id - _id of the app
    * @param {object} query - mongodb query to select which app users data to export
    * @param {function} callback - called when finished providing error (if any) as first param and array with uids of exported users as second
    */
    usersApi.export = function(app_id, query,params, callback){
        common.db.collection("app_users"+app_id).aggregate([
            {
                $match: query
            },
            {
                $group: {
                    _id: null,
                    uid: { $addToSet: '$uid' }
                }
            }
        ], {allowDiskUse:true}, function(err, res){
            if(err)
            {
                callback({message:err,filename:""},"");
                return;
            }
            if(res &amp;&amp; res[0] &amp;&amp; res[0].uid &amp;&amp; res[0].uid.length){
                //create export folder
                var eid = res[0].uid[0];
                var single_user=true;
                if(res[0].uid.length>1)//if more than one user - create hash
                {
                    var sorted = res[0].uid.sort();
                    eid = "HASH_"+crypto.createHash('SHA1').update(JSON.stringify(sorted)).digest('hex');
                    single_user=false;
                }

                var export_folder = path.resolve(__dirname,'./../../../export');
                if (!fs.existsSync(export_folder)) {
                    try {fs.mkdirSync(export_folder);}catch(err){callback(err,[]);}
                }
                
                export_folder = path.resolve(__dirname,'./../../../export/AppUser');
                if (!fs.existsSync(export_folder)) {
                    try {fs.mkdirSync(export_folder);}catch(err){callback(err,[]);}
                }
                
                export_folder = path.resolve(__dirname,'./../../../export/AppUser/appUser_'+app_id+'_'+eid);
                
                if (fs.existsSync(export_folder+'.tar.gz')) {
                    callback({message:'There is exported data for given users on server.Delete it to start new',filename:'appUser_'+app_id+'_'+eid+'.tar.gz'},"");
                    return;
                }
                
                if (!fs.existsSync(export_folder)) {
                    try {fs.mkdirSync(export_folder);}catch(err){callback(err,[]);}
                }
                else
                {
                    callback({message:'There is ongoing export data on server with the same users.Wait till finish or delete it to start new',filename:'appUser_'+app_id+'_'+eid},"");
                    return;
                }
                var export_filename = 'appUser_'+app_id+'_'+eid;
                
                var dbstr="";
                var export_commands = {};
                var db_params = plugins.getDbConnectionParams('countly');
                for(var p in db_params){
                    dbstr += " --"+p+" "+db_params[p];
                }
               //update db if one user
                new Promise(function (resolve, reject) {
                    if(single_user)
                        common.db.collection('app_users' + app_id).update({"uid":eid},{$set:{"appUserExport":export_folder+""}}, {upsert:false}, function(err, res1) {
                            if(err)
                                reject(err);
                            else
                                resolve();
                        });
                    else
                        resolve();
                }).then(function(){
                    //export data from metric_changes
                    return run_command('mongoexport ' + dbstr + ' --collection metric_changes'+app_id+' -q \'{uid:{$in: ["'+res[0].uid.join('","')+'"]}}\' --out '+ export_folder+'/metric_changes'+app_id+'.json');
                }).then( function(){
                    //export data from app_users
                    return run_command('mongoexport ' + dbstr + ' --collection app_users'+app_id+' -q \'{uid: {$in: ["'+res[0].uid.join('","')+'"]}}\' --out '+ export_folder+'/app_users'+app_id+'.json');
                 }).then(
                    function(result) {
                        //get other export commands from other plugins
                        plugins.dispatch("/i/app_users/export", {app_id:app_id,dbstr:dbstr,export_commands:export_commands, query:query, uids:res[0].uid,export_folder:export_folder}, function(){
                            var commands = [];
                            for (var prop in export_commands) {
                                for( var p=0; p&lt;export_commands[prop].length; p++)
                                {
                                    commands.push(run_command(export_commands[prop][p]));
                                }
                            }
                            Promise.all(commands).then(
                                function(result) {
                                //pack export
                                    clear_out_empty_files(path.resolve(__dirname,'./../../../export/AppUser/'+export_filename))//remove empty files
                                    .then(function(){ return run_command("tar -cvf "+export_filename+".tar.gz"+" "+export_filename)}) //create archive
                                    .then(function(){
                                        return new Promise(function(resolve, reject){/*save export in gridFS*/
                                            var my_filename = path.resolve(__dirname,'./../../../export/AppUser/'+export_filename+'.tar.gz')
                                            countlyFs.gridfs.saveFile("appUsers", my_filename, my_filename, {id:export_filename+".tar.gz",writeMode:"overwrite"}, function(err){
                                                if(err)
                                                {
                                                    console.log(err);
                                                    reject("unable to store exported file. There is more information in log.");
                                                }
                                                else
                                                {
                                                //remove archive, because it is saved in db.
                                                    try {fs.unlinkSync(my_filename);}
                                                    catch(err){ console.log(err);}
                                                    resolve();//resolve anyway because export is still OK
                                                }
                                            });
                                        });
                                    })
                                    .then(
                                        function(result) {
                                            fse.remove(export_folder, err => {
                                                if (err) {
                                                    plugins.dispatch("/systemlogs", {params:params, action:"export_app_user", data:{result:"error",uids:res[0].uid.join(", "),app_id:app_id,info:"There was error during cleanup. you should remove data folder manualy.",export_file:export_folder+".tar.gz", export_folder:export_folder}});
                                                    callback({message:"Export successful. Export saved as given filename.  Was  unable to clean up data associated with export. You can try to delete it via api.",filename:"export_filename+".tar.gz},"");
                                                } 
                                                else
                                                {
                                                    if(single_user==true)
                                                    {
                                                        //update user document
                                                        common.db.collection('app_users' + app_id).update({"uid":eid},{$set:{"appUserExport":export_folder+".tar.gz"}}, {upsert:false}, function(err, res1) {
                                                            if(!err &amp;&amp; res1.result &amp;&amp; res1.result.n!=0 &amp;&amp; res1.result.nModified!=0)
                                                            {
                                                                plugins.dispatch("/systemlogs", {params:params, action:"export_app_user", data:{result:"ok",uids:res[0].uid.join(", "),app_id:app_id,info:"Export successful",export_file:export_folder+".tar.gz"}});
                                                                callback(null, export_filename+".tar.gz");
                                                            }
                                                            else//not updated (not exist or errored)
                                                            {
                                                                plugins.dispatch("/systemlogs", {params:params, action:"export_app_user", data:{result:"error",uids:res[0].uid.join(", "),app_id:app_id,info:"User not exist",export_folder:export_folder}});
                                                                usersApi.deleteExport(export_filename,params,function(err,msg){
                                                                    if(err)
                                                                        callback({mesage:"Exporting failed. User does not exist. Unable to clean exported data",filename:'appUser_'+app_id+'_'+eid},"");
                                                                    else
                                                                        callback({mesage:"Exporting failed. User does not exist. Partially exported data deleted.",filename:'appUser_'+app_id+'_'+eid},"");
                                                                });
                                                            
                                                            }
                                                                
                                                        });
                                                    }
                                                    else
                                                    {
                                                        plugins.dispatch("/systemlogs", {params:params, action:"export_app_user", data:{result:"ok",uids:res[0].uid.join(", "),app_id:app_id,info:"Export successful",export_file:export_folder+".tar.gz"}});
                                                        callback(null, export_filename+".tar.gz");
                                                    }
                                                }
                                            });
                                        }, 
                                        function(error) {
                                            plugins.dispatch("/systemlogs", {params:params, action:"export_app_user", data:{result:"error",uids:res[0].uid.join(", "),app_id:app_id,info:err,export_folder:export_folder}});
                                            usersApi.deleteExport(export_filename,params,function(err,msg){
                                                if(err)
                                                    callback({mesage:"Storing exported files failed. Unable to clean up file system.",filename:'appUser_'+app_id+'_'+eid},"");
                                                else
                                                    callback({mesage:"Storing exported files failed. Partially exported data deleted.",filename:'appUser_'+app_id+'_'+eid},"");
                                            });
                                        }
                                    ).catch(err => {
                                        plugins.dispatch("/systemlogs", {params:params, action:"export_app_user", data:{result:"error",info:err}});
                                        usersApi.deleteExport(export_filename,params,function(err,msg){
                                            if(err)
                                                callback({mesage:"Storing exported files failed. Unable to clean up file system.",filename:'appUser_'+app_id+'_'+eid},"");
                                            else
                                                callback({mesage:"Storing exported files failed. Partially exported data deleted.",filename:'appUser_'+app_id+'_'+eid},"");
                                        });
                                    });
                                },
                                function(error) {
                                    console.log(error);
                                    plugins.dispatch("/systemlogs", {params:params, action:"export_app_user", data:{result:"error",uids:res[0].uid.join(", "),app_id:app_id,info:"Error during exporting files",export_folder:export_folder}});
                                    usersApi.deleteExport(export_filename,params,function(err,msg){
                                        if(err)
                                            callback({mesage:"Export failed. Unable to clean up file system.",filename:'appUser_'+app_id+'_'+eid},"");
                                        else
                                            callback({mesage:"Export failed. Partially exported data deleted.",filename:'appUser_'+app_id+'_'+eid},"");
                                    });
                                }
                            );
                        });    
                    },
                    function(error) {
                        plugins.dispatch("/systemlogs", {params:params, action:"export_app_user", data:{result:"error",info:error,uids:res[0].uid.join(", "),app_id:app_id}});
                        usersApi.deleteExport(export_filename,params,function(err,msg){
                            if(err)
                                callback({mesage:"Export failed. Unable to clean up file system.",filename:'appUser_'+app_id+'_'+eid},"");
                            else
                                callback({mesage:"Export failed. Partially exported data deleted.",filename:'appUser_'+app_id+'_'+eid},"");
                        });
                    }
                ).catch(err => {
                    plugins.dispatch("/systemlogs", {params:params, action:"export_app_user", data:{result:"error",info:err}});
                    usersApi.deleteExport(export_filename,params,function(err,msg){
                            if(err)
                                callback({mesage:"Export failed. Unable to clean up file system.",filename:'appUser_'+app_id+'_'+eid},"");
                            else
                                callback({mesage:"Export failed. Partially exported data deleted.",filename:'appUser_'+app_id+'_'+eid},"");
                        });
                });
            }
            else{
                plugins.dispatch("/systemlogs", {params:params, action:"export_app_user", data:{result:"ok",info:"There wasn't any user to export data for."}});
                callback("Query didn't mach any user","");
            }
        });
    };
}(usersApi));

plugins.extendModule("app_users", usersApi);

module.exports = usersApi;</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.3</a> on Fri Apr 13 2018 11:33:55 GMT+0000 (UTC) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/jquery-3.1.1.min.js"></script>

<script src="scripts/search.js"></script>


<script src="scripts/collapse.js"></script>



</body>
</html>
