<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>parts/jobs/manager.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Channel.html">Channel</a></li><li><a href="DefaultRetryPolicy.html">DefaultRetryPolicy</a></li><li><a href="IPCJob.html">IPCJob</a></li><li><a href="IPCRetryPolicy.html">IPCRetryPolicy</a></li><li><a href="Job.html">Job</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Job.html#cancel">cancel</a></li><li data-type='method' style='display: none;'><a href="Job.html#divide">divide</a></li><li data-type='method' style='display: none;'><a href="Job.html#getConcurrency">getConcurrency</a></li><li data-type='method' style='display: none;'><a href="Job.html#prepare">prepare</a></li><li data-type='method' style='display: none;'><a href="Job.html#retryPolicy">retryPolicy</a></li><li data-type='method' style='display: none;'><a href="Job.html#run">run</a></li></ul></li><li><a href="Manager.html">Manager</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Manager.html#run">run</a></li><li data-type='method' style='display: none;'><a href="Manager.html#runIPC">runIPC</a></li><li data-type='method' style='display: none;'><a href="Manager.html#runLocally">runLocally</a></li></ul></li><li><a href="module-api_lib_countly.model-countlyMetric.html">countlyMetric</a><ul class='members'><li data-type='member' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.fetchValue">countlyMetric.fetchValue</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.clearObject">countlyMetric.clearObject</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.extendDb">countlyMetric.extendDb</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.getBars">countlyMetric.getBars</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.getData">countlyMetric.getData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.getDb">countlyMetric.getDb</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.getMeta">countlyMetric.getMeta</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.getMetrics">countlyMetric.getMetrics</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.getNumber">countlyMetric.getNumber</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.getRangeData">countlyMetric.getRangeData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.getTableData">countlyMetric.getTableData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.getTimelineData">countlyMetric.getTimelineData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.getTotalUsersObj">countlyMetric.getTotalUsersObj</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.getUniqueMetrics">countlyMetric.getUniqueMetrics</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.reset">countlyMetric.reset</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.setDb">countlyMetric.setDb</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.setMetrics">countlyMetric.setMetrics</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.setTotalUsersObj">countlyMetric.setTotalUsersObj</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.setUniqueMetrics">countlyMetric.setUniqueMetrics</a></li></ul></li><li><a href="module-api_utils_log-Logger.html">Logger</a><ul class='members'><li data-type='member' style='display: none;'><a href="module-api_utils_log-Logger.html#.d">d</a></li><li data-type='member' style='display: none;'><a href="module-api_utils_log-Logger.html#.e">e</a></li><li data-type='member' style='display: none;'><a href="module-api_utils_log-Logger.html#.i">i</a></li><li data-type='member' style='display: none;'><a href="module-api_utils_log-Logger.html#.w">w</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_utils_log-Logger.html#.callback">callback</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_log-Logger.html#.logdb">logdb</a></li></ul></li><li><a href="NoRetryPolicy.html">NoRetryPolicy</a></li><li><a href="Resource.html">Resource</a></li><li><a href="ResourceFa%25C3%25A7ade.html">ResourceFa√ßade</a></li><li><a href="ResourcefulJob.html">ResourcefulJob</a></li><li><a href="ResourceInterface.html">ResourceInterface</a></li></ul><h3>Modules</h3><ul><li><a href="module-api_lib_countly.common.html">api/lib/countly.common</a><ul class='members'><li data-type='member' style='display: none;'><a href="module-api_lib_countly.common.html#.periodObj">periodObj</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.decode">decode</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.decodeHtml">decodeHtml</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.encode">encode</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.extractBarData">extractBarData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.extractChartData">extractChartData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.extractData">extractData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.extractMetric">extractMetric</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.extractRangeData">extractRangeData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.extractTwoLevelData">extractTwoLevelData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.getDashboardData">getDashboardData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.getDateRange">getDateRange</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.getDescendantProp">getDescendantProp</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.getPercentChange">getPercentChange</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.getPeriodObj">getPeriodObj</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.getShortNumber">getShortNumber</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.getSparklineData">getSparklineData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.getTimestampRangeQuery">getTimestampRangeQuery</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.mergeMetricsByName">mergeMetricsByName</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.setPeriod">setPeriod</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.setTimezone">setTimezone</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.timeString">timeString</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.union">union</a></li></ul></li><li><a href="module-api_lib_countly.countries.html">api/lib/countly.countries</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_lib_countly.countries.html#.getLocationData">getLocationData</a></li></ul></li><li><a href="module-api_lib_countly.device_details.html">api/lib/countly.device_details</a></li><li><a href="module-api_lib_countly.devices.html">api/lib/countly.devices</a></li><li><a href="module-api_lib_countly.event.html">api/lib/countly.event</a></li><li><a href="module-api_lib_countly.model.html">api/lib/countly.model</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model.html#.create">create</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model.html#.load">load</a></li></ul></li><li><a href="module-api_lib_countly.users.html">api/lib/countly.users</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_lib_countly.users.html#.getSessionData">getSessionData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.users.html#.getSubperiodData">getSubperiodData</a></li></ul></li><li><a href="module-api_config.html">api/config</a><ul class='members'><li data-type='member' style='display: none;'><a href="module-api_config.html#.api">api</a></li><li data-type='member' style='display: none;'><a href="module-api_config.html#.api">api</a></li><li data-type='member' style='display: none;'><a href="module-api_config.html#.encryption">encryption</a></li><li data-type='member' style='display: none;'><a href="module-api_config.html#.encryption">encryption</a></li><li data-type='member' style='display: none;'><a href="module-api_config.html#.fileStorage">fileStorage</a></li><li data-type='member' style='display: none;'><a href="module-api_config.html#.fileStorage">fileStorage</a></li><li data-type='member' style='display: none;'><a href="module-api_config.html#.ignoreProxies">ignoreProxies</a></li><li data-type='member' style='display: none;'><a href="module-api_config.html#.ignoreProxies">ignoreProxies</a></li><li data-type='member' style='display: none;'><a href="module-api_config.html#.logging">logging</a></li><li data-type='member' style='display: none;'><a href="module-api_config.html#.logging">logging</a></li><li data-type='member' style='display: none;'><a href="module-api_config.html#.mongodb">mongodb</a></li><li data-type='member' style='display: none;'><a href="module-api_config.html#.mongodb">mongodb</a></li><li data-type='member' style='display: none;'><a href="module-api_config.html#.path">path</a></li><li data-type='member' style='display: none;'><a href="module-api_config.html#.path">path</a></li></ul></li><li><a href="module-api_parts_data_exports.html">api/parts/data/exports</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_parts_data_exports.html#.convertData">convertData</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_exports.html#.fromData">fromData</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_exports.html#.fromDatabase">fromDatabase</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_exports.html#.fromRequest">fromRequest</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_exports.html#.output">output</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_exports.html#.stream">stream</a></li></ul></li><li><a href="module-api_parts_data_fetch.html">api/parts/data/fetch</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#.getMergedEventData">getMergedEventData</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#.getMetric">getMetric</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#.getTimeObj">getTimeObj</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#.getTimeObjForEvents">getTimeObjForEvents</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#.getTotalUsersObj">getTotalUsersObj</a></li></ul></li><li><a href="module-api_utils_authorizer.html">api/utils/authorizer</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_utils_authorizer.html#.clean">clean</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_authorizer.html#.getToken">getToken</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_authorizer.html#.read">read</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_authorizer.html#.save">save</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_authorizer.html#.verify">verify</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_authorizer.html#.verify_return">verify_return</a></li></ul></li><li><a href="module-api_utils_common.html">api/utils/common</a><ul class='members'><li data-type='member' style='display: none;'><a href="module-api_utils_common.html#.base64">base64</a></li><li data-type='member' style='display: none;'><a href="module-api_utils_common.html#.config">config</a></li><li data-type='member' style='display: none;'><a href="module-api_utils_common.html#.crypto">crypto</a></li><li data-type='member' style='display: none;'><a href="module-api_utils_common.html#.dbEventMap">dbEventMap</a></li><li data-type='member' style='display: none;'><a href="module-api_utils_common.html#.dbMap">dbMap</a></li><li data-type='member' style='display: none;'><a href="module-api_utils_common.html#.dbUserMap">dbUserMap</a></li><li data-type='member' style='display: none;'><a href="module-api_utils_common.html#.log">log</a></li><li data-type='member' style='display: none;'><a href="module-api_utils_common.html#.moment">moment</a></li><li data-type='member' style='display: none;'><a href="module-api_utils_common.html#.os_mapping">os_mapping</a></li><li data-type='member' style='display: none;'><a href="module-api_utils_common.html#.time">time</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.adjustTimestampByTimezone">adjustTimestampByTimezone</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.arrayAddUniq">arrayAddUniq</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.blockResponses">blockResponses</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.checkPromise">checkPromise</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.convertToType">convertToType</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.dot">dot</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.fillTimeObject">fillTimeObject</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.fillTimeObjectMonth">fillTimeObjectMonth</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.fillTimeObjectZero">fillTimeObjectZero</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.fixEventKey">fixEventKey</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.getDate">getDate</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.getDateIds">getDateIds</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.getDaysInYear">getDaysInYear</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.getDescendantProp">getDescendantProp</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.getDiff">getDiff</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.getDOY">getDOY</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.getIpAddress">getIpAddress</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.getISOWeeksInYear">getISOWeeksInYear</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.indexOf">indexOf</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.initTimeObj">initTimeObj</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.isNumber">isNumber</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.md5Hash">md5Hash</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.o">o</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.optional">optional</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.processCarrier">processCarrier</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.recordCustomMetric">recordCustomMetric</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.returnMessage">returnMessage</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.returnOutput">returnOutput</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.safeDivision">safeDivision</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.sha1Hash">sha1Hash</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.sha512Hash">sha512Hash</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.unblockResponses">unblockResponses</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.updateAppUser">updateAppUser</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.validateArgs">validateArgs</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.versionCompare">versionCompare</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.zeroFill">zeroFill</a></li></ul></li><li><a href="module-api_utils_countlyFs.html">api/utils/countlyFs</a><ul class='members'><li data-type='member' style='display: none;'><a href="module-api_utils_countlyFs.html#.fs">fs</a></li><li data-type='member' style='display: none;'><a href="module-api_utils_countlyFs.html#.gridfs">gridfs</a></li><li data-type='member' style='display: none;'><a href="module-api_utils_countlyFs.html#.type">type</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_utils_countlyFs.html#.deleteFile">deleteFile</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_countlyFs.html#.exists">exists</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_countlyFs.html#.getData">getData</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_countlyFs.html#.getHandler">getHandler</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_countlyFs.html#.getSize">getSize</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_countlyFs.html#.getStats">getStats</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_countlyFs.html#.getStream">getStream</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_countlyFs.html#.rename">rename</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_countlyFs.html#.saveData">saveData</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_countlyFs.html#.saveFile">saveFile</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_countlyFs.html#.saveStream">saveStream</a></li></ul></li><li><a href="module-api_utils_localization.html">api/utils/localization</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_utils_localization.html#.format">format</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_localization.html#.getProperties">getProperties</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_localization.html#.getProperty">getProperty</a></li></ul></li><li><a href="module-api_utils_log.html">api/utils/log</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_utils_log.html#.getLevel">getLevel</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_log.html#.ipcHandler">ipcHandler</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_log.html#.setDefault">setDefault</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_log.html#.setLevel">setLevel</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_log.html#~log">log</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_log.html#~logLevel">logLevel</a></li></ul></li><li><a href="module-api_utils_rights.html">api/utils/rights</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_utils_rights.html#.validateGlobalAdmin">validateGlobalAdmin</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_rights.html#.validateUser">validateUser</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_rights.html#.validateUserForRead">validateUserForRead</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_rights.html#.validateUserForWrite">validateUserForWrite</a></li></ul></li><li><a href="module-api_utils_taskmanager.html">api/utils/taskmanager</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.checkIfRunning">checkIfRunning</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.checkResult">checkResult</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.createTask">createTask</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.deleteResult">deleteResult</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.errorResults">errorResults</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.getId">getId</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.getResult">getResult</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.getResults">getResults</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.longtask">longtask</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.nameResult">nameResult</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.rerunTask">rerunTask</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.saveResult">saveResult</a></li></ul></li><li><a href="module-api_utils_utils.html">api/utils/utils</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_utils_utils.html#.decrypt">decrypt</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_utils.html#.encrypt">encrypt</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#debounce">debounce</a></li><li><a href="global.html#IPC">IPC</a></li><li><a href="global.html#params">params</a></li><li><a href="global.html#timeObject">timeObject</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">parts/jobs/manager.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';

const JOB = require('./job.js'),
	  IPC = require('./ipc.js'),
	  scan = require('./scanner.js'),
	  RES = require('./resource.js'),
	  STATUS = JOB.STATUS,
	  log = require('../../utils/log.js')('jobs:manager'),
	  manager = require('../../../plugins/pluginManager.js'),
	  later = require('later');

const DELAY_BETWEEN_CHECKS = 1000,
	  MAXIMUM_IN_LINE_JOBS_PER_NAME = 10;

/**
 * Manager obviously manages jobs running: monitors jobs collection &amp; IPC messages, runs jobs dividing then if necessary, starts and manages 
 * corresponding resources and reports jobs statuses back to the one who started them: IPC or jobs collection.
 */
class Manager {
	constructor() {
		log.i('Starting job manager');

		this.classes = {};		// {'job name': Constructor}
		this.files = {};		// {'ping': '/usr/local/countly/api/jobs/ping.js'}
		this.processes = {};	// {job1Id: [fork1, fork2], job2Id: [fork3, fork4], job3Id: []}     job3 is small and being run on this process, job1/2 are IPC ones
		this.running = {};		// {'push:apn:connection': [resource1, resource2], 'xxx': [resource3]}
		this.resources = [];	// {'push:apn:connection': [job1, job2]}
		// Once job is done running (goes out of running), if it's resourceful job, it goes into resources until resource is closed or another job of this type is being run

		this.db = manager.singleDefaultConnection();
		// JOB.setDB(this.db);
		this.collection = this.db.collection('jobs');
		// this.collection.update({status: STATUS.RUNNING, started: {$lt: Date.now() - 60 * 60 * 1000}}, {$set: {status: STATUS.CANCELLED, error: 'Cancelled on restart', done: Date.now()}}, {multi: true}, log.logdb('resetting interrupted jobs'));

		// setTimeout(() => {
		// 	let Constructor = this.classes['api:ipcTest'];
		// 	new Constructor('api:ipcTest', {root: true}).now();
		// }, 3000)

		scan(this.db, this.files, this.classes).then(() => {
			this.types = Object.keys(this.classes);
			log.i('Found %d job types, starting monitoring: %j', this.types.length, this.types);
			// cancel jobs star
			// this.collection.update({status: STATUS.RUNNING, $or: [{modified: {$lt: Date.now() - 60000}}, {modified: null}, {modified: {$exists: false}}]}, {$set: {status: STATUS.CANCELLED, error: 'Cancelled on restart', done: Date.now()}}, {multi: true}, () => {
			this.collection.find({status: STATUS.RUNNING, $or: [{modified: {$lt: Date.now() - 60000}}, {modified: null}, {modified: {$exists: false}}]}).toArray((err, toCancel) => {
				if (err) {
					log.e(err);
				}

				log.d('Cancelling %d jobs', toCancel ? toCancel.length : null);
				try {
					let sequence = (arr, transform) => {
						return new Promise((resolve, reject) => {
							var next = () => {
								let promise = transform(arr.pop());
								if (arr.length) {
									promise.then(next, reject);
								} else {
									promise.then(resolve, reject);
								}
							};
							if (!arr.length) {
								resolve();
							} else {
								next();
							}
						});
					};
					let promise = toCancel &amp;&amp; toCancel.length ? sequence(toCancel, j => this.create(j).cancel(this.db)) : Promise.resolve(),
						resume = () => {
							log.d('Resuming after cancellation');
							this.collection.find({status: STATUS.PAUSED}).toArray((err, array) => {
								if (!err &amp;&amp; array &amp;&amp; array.length) {
									log.i('Going to resume following jobs: %j', array.map(j => {
										return {_id: j._id, name: j.name};
									}));
									this.process(array.filter(j => this.types.indexOf(j.name) !== -1));
								} else {
									this.checkAfterDelay(DELAY_BETWEEN_CHECKS * 5);
								}
							});
							// this.checkAfterDelay(DELAY_BETWEEN_CHECKS * 5);
						};
					promise.then(resume, resume);
				} catch(e) {
					log.e(e, e.stack);
					this.checkAfterDelay(DELAY_BETWEEN_CHECKS * 5);
				}
			});
		}, (e) => {
			log.e('Error when loading jobs', e, e.stack);
			this.checkAfterDelay();
		});

		// Listen for transient jobs
		require('cluster').on('online', worker => {
			let channel = new IPC.IdChannel(JOB.EVT.TRANSIENT_CHANNEL).attach(worker).on(JOB.EVT.TRANSIENT_RUN, (json) => {
				log.d('[%d]: Got transient job request %j', process.pid, json);
				this.start(this.create(json)).then((data) => {
					log.d('[%d]: Success running transient job %j', process.pid, json, data);
					if (data) {
						json.result = data;
					}
					channel.send(JOB.EVT.TRANSIENT_DONE, json);
				}, (error) => {
					log.d('[%d]: Error when running transient job %j: ', process.pid, json, error);
					if (error &amp;&amp; error.toString()) {
						json.error = error.toString().replace('Error: ', '');
					} else {
						json.error = 'Unknown push error';
					}
					if (!json.error) { json.error = 'Unknown push error'; }
					channel.send(JOB.EVT.TRANSIENT_DONE, json);
				});
			});
		});

		// Close all resources on main process exit
		process.on('exit', () => {
			for (let k in this.resources) { this.resources[k].close(); }
		});
	}

	job (name, data) {
		let Constructor = this.classes[name];
		if (Constructor) {
			return new Constructor(name, data);
		} else { 
			throw new Error('Couldn\'t find job file named ' + name);
		}
	}

	checkAfterDelay (delay) {
		if (this.checkingAfterDelay) { return; }
		this.checkingAfterDelay = true;
		setTimeout(() => {
			this.checkingAfterDelay = false;
			this.check();
		}, delay || DELAY_BETWEEN_CHECKS);
	}

	check () {
		var find = {status: STATUS.SCHEDULED, next: {$lt: Date.now()}, name: {$in: this.types}};

		log.d('Looking for jobs ...'); 
		this.collection.find(find).sort({next: 1}).limit(MAXIMUM_IN_LINE_JOBS_PER_NAME).toArray((err, jobs) => {
			if (err) { 
				log.e('Error while looking for jobs: %j', err); 
				this.checkAfterDelay();
			} else if (!jobs) {
				log.d('No jobs so far');
				this.checkAfterDelay();
			} else {
				this.process(jobs);
			}
		});
	}

	process (jobs) {
		var promises = [];
		jobs.forEach(json => {
			var job = this.create(json);

			if (job.next > Date.now()) {
				// return console.log('Skipping job %j', job);
				return;
			}

			if (!this.classes[job.name]) {
				log.d('Cannot process job %j - no processor', job);
				return;
			}

			if (!this.canRun(job)) {
				log.d('Cannot process job %j - concurrency limit', job);
				return;
			}

			log.i('Trying to start job %j', json);
			let update = {
				$set: {status: STATUS.RUNNING, started: Date.now()}
			};

			job._json.status = STATUS.RUNNING;
			job._json.started = update.$set.started;

			if (job.strict !== null) {
				if ((Date.now() - job.next) > job.strict) {
					update.$set.status = job._json.status = STATUS.DONE;
					update.$set.done = job._json.done =  Date.now();
					update.$set.error = job._json.error = 'Job expired';
					delete update.$set.next;
					delete job._json.next;
					promises.push(job._save(update.$set));
					promises.push(this.schedule(job));
					return;
				}
			}

			promises.push(new Promise((resolve) => {
				this.collection.findAndModify({_id: job._json._id, status: {$in: [STATUS.RUNNING, STATUS.SCHEDULED, STATUS.PAUSED]}}, [['_id', 1]], update, (err, res) => {
					if (err) {
						log.e('Couldn\'t update a job: %j', err);
						resolve();
					} else if (!res || !res.value) {
						// ignore
						resolve();
					} else if (res.value.status === STATUS.RUNNING) {
						log.i('Job %s is running on another server, won\'t start it here', job._id);
						resolve();
					} else if (res.value.status === STATUS.SCHEDULED || res.value.status === STATUS.PAUSED) {
						if (!this.start(job)) {
							this.collection.findAndModify({_id: job._json._id, status: STATUS.RUNNING}, [['_id', 1]], {$set: {status: STATUS.SCHEDULED}}, log.logDb('resetting job', resolve));
						} else {
							resolve();
						}
					}
				});
			}));
		});
		Promise.all(promises).then(this.checkAfterDelay.bind(this, null), this.checkAfterDelay.bind(this, null));
	}

	schedule (job) {
		if (job.scheduleObj) {
			var schedule = typeof job.scheduleObj === 'string' ? later.parse.text(job.scheduleObj) : job.scheduleObj,
				nextFrom = new Date(job.next);
			var next = later.schedule(schedule).next(2, nextFrom);
			if (next &amp;&amp; next.length > 1) {
				if (job.strict !== null) { 
					// for strict jobs we're going to repeat all missed tasks up to current date after restart
					// for non-strict ones, we want to start from current date
					while (next[1].getTime() &lt; Date.now()) {
						next = later.schedule(schedule).next(2, next[1]);
						if (next.length &lt; 2) { return; }
					}
				}
				return job.schedule(job.scheduleObj, job.strict, next[1].getTime());
			}
		}
		return Promise.resolve();
	} 

	/*
	 * Runs job &amp; returns a promise
	 */
	start (job) {

		if (this.canRun(job)) {
			if (!this.running[job.name]) { this.running[job.name] = []; }
			this.running[job.name].push(job);

			return new Promise((resolve, reject) => {
				job.prepare(this, this.db).then(() => {
					log.d('prepared %j', job._idIpc);
					this.run(job).then((upd) => {
						log.d('result in start, %j', upd);
						this.schedule(job);
						resolve(upd ? upd.result : undefined);
					}, (error) => {
						this.schedule(job);
						reject(error);
					} );
				}, reject);
			});
		}
	}

	/**
	 * Run job by creating IPCFa√ßadeJob with actual job: instantiate or pick free resource, run it there. Returns a promise.
	 */
	runIPC (job) {
		log.d('%s: runIPC', job._idIpc);

		if (job.isSub) {
			let fa√ßade = job._transient ? new JOB.TransientFa√ßadeJob(job, this.getResource.bind(this, job)) : new JOB.IPCFa√ßadeJob(job, this.getResource.bind(this, job));
			return this.runLocally(fa√ßade);
		} else {
			return new Promise((resolve, reject) => {
				log.d('%s: dividing', job._idIpc);
				job.divide(this.db).then((obj) => {						// runs user code to divide job
					var subs = obj.subs,
						workersCount = obj.workers;
					log.d('%s: divided into %d sub(s) in %d worker(s)', job._idIpc, subs.length, workersCount);
					if (subs.length === 0) {							// no subs, run in local process
						log.d('%s: no subs, running locally', job._idIpc);
						this.runLocally(job).then(upd => {
							log.d('%s: done running locally with %j', job._idIpc, upd);
							job._save(upd);
							resolve(upd);
						}, reject);
					} else {											// one and more subs, run through IPC
						job._divide(subs).then(() => {					// set sub idx &amp; _id, save in DB
							try {
								subs = job._json.subs.map(sub => this.create(sub));
								job._json.size = job._json.subs.reduce((p, c) => {
									return {size: p.size + c.size};
								}).size;
								job._json.done = 0;
								job._save({size: job._json.size, done: 0});

								var running = [],
									rejected = false,
									remove = (sub) => {
										let idx = running.indexOf(sub);
										if (idx !== -1) {
											running.splice(idx, 1);
										} else {
											log.w('%s: -1 indexOf %j in %j', job._idIpc, sub, running);
										}
									},
									next = () => {
										if (!rejected &amp;&amp; running.length &lt; workersCount &amp;&amp; subs.length > 0 &amp;&amp; this.getPool(subs[0]).canRun()) {
											let sub = subs.shift();
											sub.parent = job;
											log.d('%s: running next sub %s', job._idIpc, sub._idIpc);
											this.runIPC(sub).then(() => {
												log.d('%s: succeeded', sub._idIpc);
												remove(sub);
												next();
											}, (error) => {
												log.d('%s: failed with %s', sub._idIpc, error, error.stack);
												remove(sub);
												rejected = true;
												reject(error);
												throw error;
											});
											running.push(sub);
											next();
										} else if (!rejected &amp;&amp; running.length &lt; workersCount &amp;&amp; subs.length > 0 &amp;&amp; !this.getPool(subs[0]).canRun()) {
											log.d('%s: not ready to run yet', job._idIpc);
											setTimeout(next, 5000);
										} else if (running.length === 0 &amp;&amp; subs.length === 0) {
											try {
												log.d('%s: all subs done, resolving', job._idIpc);
												resolve();
											} catch(e) {
												log.e(e, e.stack);
											}
										} else {
											log.d('%s: waiting for all subs to resolve (%d running, %d left to run)', job._idIpc, running.length, subs.length);
										}
									};

								log.d('[%s]: prepaing subs', job._idIpc);
								Promise.all(subs.map(s => s.prepare(this, this.db))).then(() => {
									log.d('[%s]: starting first sub', job._idIpc);
									next();
								}, reject);

							} catch (e) {
								log.e(e, e.stack);
								reject(e);
							}
						}, reject);
					}
				});
			});
		}
	}

	/**
	 * Run instantiated Job locally. Returns a promise.
	 */
	runLocally (job) {
		log.d('%s runLocally', job._idIpc);
		return job._runWithRetries().catch((error) => {
			if (job.status !== STATUS.DONE) {
				log.w('Job is not done on error after _runWithRetries', error);
				job._json.duration = Date.now() - job._json.started;
				job._json.error = '' + error;
				job._json.status = STATUS.DONE;
				job._save(job._json);
			}
			throw error;
		});
	}

	/**
	 * Run any job with handling retries if necessary. Returns a promise.
	 */
	run (job) {
		if (job instanceof JOB.IPCJob) {
			return this.runIPC(job);
		} else {
			return this.runLocally(job);
		}
	}

	create (json) {
		let Constructor = this.classes[json.name];
		return new Constructor(json);
	}

	canRun (job, count) {
		count = typeof count === 'undefined' ? 1 : count;
		let c = job.getConcurrency(),
			n = (this.running[job.name] || []).length;
		return c === 0 || (n.length + count) &lt;= c;
	}

	getPool (job) {
		if (!this.resources[job.resourceName()]) {
			this.resources[job.resourceName()] = new RES.ResourcePool(() => {
				return new RES.ResourceFa√ßade(job, this.files[job.name]);
			}, 10);
			this.resources[job.resourceName()].on(RES.EVT.CLOSED, () => {
				log.w('all pool resources done');
				delete this.resources[job.resourceName()];
			});
		}

		return this.resources[job.resourceName()];
	}

	getResource (job) {
		return this.getPool(job).getResource();
	}

	hasResources (job) {
		return this.getPool(job).canRun();
	}

	get ipc () {
		return IPC;
	}
}

if (!Manager.instance) {
	Manager.instance = new Manager();
}

module.exports = Manager.instance;
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.3</a> on Mon Feb 05 2018 12:11:46 GMT+0000 (UTC) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/jquery-3.1.1.min.js"></script>

<script src="scripts/search.js"></script>


<script src="scripts/collapse.js"></script>



</body>
</html>
