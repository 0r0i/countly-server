<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>parts/jobs/resource.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Channel.html">Channel</a></li><li><a href="DefaultRetryPolicy.html">DefaultRetryPolicy</a></li><li><a href="IPCJob.html">IPCJob</a></li><li><a href="IPCRetryPolicy.html">IPCRetryPolicy</a></li><li><a href="Job.html">Job</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Job.html#cancel">cancel</a></li><li data-type='method' style='display: none;'><a href="Job.html#divide">divide</a></li><li data-type='method' style='display: none;'><a href="Job.html#getConcurrency">getConcurrency</a></li><li data-type='method' style='display: none;'><a href="Job.html#prepare">prepare</a></li><li data-type='method' style='display: none;'><a href="Job.html#retryPolicy">retryPolicy</a></li><li data-type='method' style='display: none;'><a href="Job.html#run">run</a></li></ul></li><li><a href="Manager.html">Manager</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Manager.html#run">run</a></li><li data-type='method' style='display: none;'><a href="Manager.html#runIPC">runIPC</a></li><li data-type='method' style='display: none;'><a href="Manager.html#runLocally">runLocally</a></li></ul></li><li><a href="module-api_lib_countly.model-countlyMetric.html">countlyMetric</a><ul class='members'><li data-type='member' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.fetchValue">countlyMetric.fetchValue</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.clearObject">countlyMetric.clearObject</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.extendDb">countlyMetric.extendDb</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.getBars">countlyMetric.getBars</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.getData">countlyMetric.getData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.getDb">countlyMetric.getDb</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.getMeta">countlyMetric.getMeta</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.getMetrics">countlyMetric.getMetrics</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.getNumber">countlyMetric.getNumber</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.getRangeData">countlyMetric.getRangeData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.getTableData">countlyMetric.getTableData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.getTimelineData">countlyMetric.getTimelineData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.getTotalUsersObj">countlyMetric.getTotalUsersObj</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.getUniqueMetrics">countlyMetric.getUniqueMetrics</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.reset">countlyMetric.reset</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.setDb">countlyMetric.setDb</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.setMetrics">countlyMetric.setMetrics</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.setTotalUsersObj">countlyMetric.setTotalUsersObj</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.setUniqueMetrics">countlyMetric.setUniqueMetrics</a></li></ul></li><li><a href="module-api_utils_log-Logger.html">Logger</a><ul class='members'><li data-type='member' style='display: none;'><a href="module-api_utils_log-Logger.html#.d">d</a></li><li data-type='member' style='display: none;'><a href="module-api_utils_log-Logger.html#.e">e</a></li><li data-type='member' style='display: none;'><a href="module-api_utils_log-Logger.html#.i">i</a></li><li data-type='member' style='display: none;'><a href="module-api_utils_log-Logger.html#.w">w</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_utils_log-Logger.html#.callback">callback</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_log-Logger.html#.logdb">logdb</a></li></ul></li><li><a href="NoRetryPolicy.html">NoRetryPolicy</a></li><li><a href="Resource.html">Resource</a></li><li><a href="ResourceFa%25C3%25A7ade.html">ResourceFa√ßade</a></li><li><a href="ResourcefulJob.html">ResourcefulJob</a></li><li><a href="ResourceInterface.html">ResourceInterface</a></li></ul><h3>Modules</h3><ul><li><a href="module-api_lib_countly.common.html">api/lib/countly.common</a><ul class='members'><li data-type='member' style='display: none;'><a href="module-api_lib_countly.common.html#.periodObj">periodObj</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.decode">decode</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.decodeHtml">decodeHtml</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.encode">encode</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.extractBarData">extractBarData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.extractChartData">extractChartData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.extractData">extractData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.extractMetric">extractMetric</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.extractRangeData">extractRangeData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.extractTwoLevelData">extractTwoLevelData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.getDashboardData">getDashboardData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.getDateRange">getDateRange</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.getDescendantProp">getDescendantProp</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.getPercentChange">getPercentChange</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.getPeriodObj">getPeriodObj</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.getShortNumber">getShortNumber</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.getSparklineData">getSparklineData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.getTimestampRangeQuery">getTimestampRangeQuery</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.mergeMetricsByName">mergeMetricsByName</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.setPeriod">setPeriod</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.setTimezone">setTimezone</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.timeString">timeString</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.union">union</a></li></ul></li><li><a href="module-api_lib_countly.countries.html">api/lib/countly.countries</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_lib_countly.countries.html#.getLocationData">getLocationData</a></li></ul></li><li><a href="module-api_lib_countly.device_details.html">api/lib/countly.device_details</a></li><li><a href="module-api_lib_countly.devices.html">api/lib/countly.devices</a></li><li><a href="module-api_lib_countly.event.html">api/lib/countly.event</a></li><li><a href="module-api_lib_countly.model.html">api/lib/countly.model</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model.html#.create">create</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model.html#.load">load</a></li></ul></li><li><a href="module-api_lib_countly.users.html">api/lib/countly.users</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_lib_countly.users.html#.getSessionData">getSessionData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.users.html#.getSubperiodData">getSubperiodData</a></li></ul></li><li><a href="module-api_config.html">api/config</a><ul class='members'><li data-type='member' style='display: none;'><a href="module-api_config.html#.api">api</a></li><li data-type='member' style='display: none;'><a href="module-api_config.html#.api">api</a></li><li data-type='member' style='display: none;'><a href="module-api_config.html#.encryption">encryption</a></li><li data-type='member' style='display: none;'><a href="module-api_config.html#.encryption">encryption</a></li><li data-type='member' style='display: none;'><a href="module-api_config.html#.fileStorage">fileStorage</a></li><li data-type='member' style='display: none;'><a href="module-api_config.html#.fileStorage">fileStorage</a></li><li data-type='member' style='display: none;'><a href="module-api_config.html#.ignoreProxies">ignoreProxies</a></li><li data-type='member' style='display: none;'><a href="module-api_config.html#.ignoreProxies">ignoreProxies</a></li><li data-type='member' style='display: none;'><a href="module-api_config.html#.logging">logging</a></li><li data-type='member' style='display: none;'><a href="module-api_config.html#.logging">logging</a></li><li data-type='member' style='display: none;'><a href="module-api_config.html#.mongodb">mongodb</a></li><li data-type='member' style='display: none;'><a href="module-api_config.html#.mongodb">mongodb</a></li><li data-type='member' style='display: none;'><a href="module-api_config.html#.path">path</a></li><li data-type='member' style='display: none;'><a href="module-api_config.html#.path">path</a></li></ul></li><li><a href="module-api_parts_data_exports.html">api/parts/data/exports</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_parts_data_exports.html#.convertData">convertData</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_exports.html#.fromData">fromData</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_exports.html#.fromDatabase">fromDatabase</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_exports.html#.fromRequest">fromRequest</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_exports.html#.output">output</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_exports.html#.stream">stream</a></li></ul></li><li><a href="module-api_parts_data_fetch.html">api/parts/data/fetch</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#.getMergedEventData">getMergedEventData</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#.getMetric">getMetric</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#.getTimeObj">getTimeObj</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#.getTimeObjForEvents">getTimeObjForEvents</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#.getTotalUsersObj">getTotalUsersObj</a></li></ul></li><li><a href="module-api_parts_mgmt_app_users.html">api/parts/mgmt/app_users</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_app_users.html#.count">count</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_app_users.html#.create">create</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_app_users.html#.delete">delete</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_app_users.html#.export">export</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_app_users.html#.getUid">getUid</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_app_users.html#.merge">merge</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_app_users.html#.search">search</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_app_users.html#.update">update</a></li></ul></li><li><a href="module-api_utils_authorizer.html">api/utils/authorizer</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_utils_authorizer.html#.clean">clean</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_authorizer.html#.getToken">getToken</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_authorizer.html#.read">read</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_authorizer.html#.save">save</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_authorizer.html#.verify">verify</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_authorizer.html#.verify_return">verify_return</a></li></ul></li><li><a href="module-api_utils_common.html">api/utils/common</a><ul class='members'><li data-type='member' style='display: none;'><a href="module-api_utils_common.html#.base64">base64</a></li><li data-type='member' style='display: none;'><a href="module-api_utils_common.html#.config">config</a></li><li data-type='member' style='display: none;'><a href="module-api_utils_common.html#.crypto">crypto</a></li><li data-type='member' style='display: none;'><a href="module-api_utils_common.html#.dbEventMap">dbEventMap</a></li><li data-type='member' style='display: none;'><a href="module-api_utils_common.html#.dbMap">dbMap</a></li><li data-type='member' style='display: none;'><a href="module-api_utils_common.html#.dbUserMap">dbUserMap</a></li><li data-type='member' style='display: none;'><a href="module-api_utils_common.html#.log">log</a></li><li data-type='member' style='display: none;'><a href="module-api_utils_common.html#.moment">moment</a></li><li data-type='member' style='display: none;'><a href="module-api_utils_common.html#.os_mapping">os_mapping</a></li><li data-type='member' style='display: none;'><a href="module-api_utils_common.html#.time">time</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.adjustTimestampByTimezone">adjustTimestampByTimezone</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.arrayAddUniq">arrayAddUniq</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.blockResponses">blockResponses</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.checkPromise">checkPromise</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.convertToType">convertToType</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.dot">dot</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.fillTimeObject">fillTimeObject</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.fillTimeObjectMonth">fillTimeObjectMonth</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.fillTimeObjectZero">fillTimeObjectZero</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.fixEventKey">fixEventKey</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.getDate">getDate</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.getDateIds">getDateIds</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.getDaysInYear">getDaysInYear</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.getDescendantProp">getDescendantProp</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.getDiff">getDiff</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.getDOY">getDOY</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.getIpAddress">getIpAddress</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.getISOWeeksInYear">getISOWeeksInYear</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.indexOf">indexOf</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.initTimeObj">initTimeObj</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.isNumber">isNumber</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.md5Hash">md5Hash</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.o">o</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.optional">optional</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.parseSequence">parseSequence</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.processCarrier">processCarrier</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.recordCustomMetric">recordCustomMetric</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.recordMetric">recordMetric</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.returnMessage">returnMessage</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.returnOutput">returnOutput</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.returnRaw">returnRaw</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.reviver">reviver</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.safeDivision">safeDivision</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.sha1Hash">sha1Hash</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.sha512Hash">sha512Hash</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.unblockResponses">unblockResponses</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.updateAppUser">updateAppUser</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.validateArgs">validateArgs</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.versionCompare">versionCompare</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.zeroFill">zeroFill</a></li></ul></li><li><a href="module-api_utils_countlyFs.html">api/utils/countlyFs</a><ul class='members'><li data-type='member' style='display: none;'><a href="module-api_utils_countlyFs.html#.fs">fs</a></li><li data-type='member' style='display: none;'><a href="module-api_utils_countlyFs.html#.gridfs">gridfs</a></li><li data-type='member' style='display: none;'><a href="module-api_utils_countlyFs.html#.type">type</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_utils_countlyFs.html#.deleteFile">deleteFile</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_countlyFs.html#.exists">exists</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_countlyFs.html#.getData">getData</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_countlyFs.html#.getHandler">getHandler</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_countlyFs.html#.getSize">getSize</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_countlyFs.html#.getStats">getStats</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_countlyFs.html#.getStream">getStream</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_countlyFs.html#.rename">rename</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_countlyFs.html#.saveData">saveData</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_countlyFs.html#.saveFile">saveFile</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_countlyFs.html#.saveStream">saveStream</a></li></ul></li><li><a href="module-api_utils_localization.html">api/utils/localization</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_utils_localization.html#.format">format</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_localization.html#.getProperties">getProperties</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_localization.html#.getProperty">getProperty</a></li></ul></li><li><a href="module-api_utils_log.html">api/utils/log</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_utils_log.html#.getLevel">getLevel</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_log.html#.ipcHandler">ipcHandler</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_log.html#.setDefault">setDefault</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_log.html#.setLevel">setLevel</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_log.html#~log">log</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_log.html#~logLevel">logLevel</a></li></ul></li><li><a href="module-api_utils_requestProcessor.html">api/utils/requestProcessor</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_utils_requestProcessor.html#.processRequest">processRequest</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_requestProcessor.html#~continueProcessingRequestData">continueProcessingRequestData</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_requestProcessor.html#~processBulkRequest">processBulkRequest</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_requestProcessor.html#~processRequestData">processRequestData</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_requestProcessor.html#~restartRequest">restartRequest</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_requestProcessor.html#~validateAppForWriteAPI">validateAppForWriteAPI</a></li></ul></li><li><a href="module-api_utils_rights.html">api/utils/rights</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_utils_rights.html#.validateGlobalAdmin">validateGlobalAdmin</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_rights.html#.validateUser">validateUser</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_rights.html#.validateUserForRead">validateUserForRead</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_rights.html#.validateUserForWrite">validateUserForWrite</a></li></ul></li><li><a href="module-api_utils_taskmanager.html">api/utils/taskmanager</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.checkIfRunning">checkIfRunning</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.checkResult">checkResult</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.createTask">createTask</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.deleteResult">deleteResult</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.errorResults">errorResults</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.getId">getId</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.getResult">getResult</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.getResults">getResults</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.longtask">longtask</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.nameResult">nameResult</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.rerunTask">rerunTask</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.saveResult">saveResult</a></li></ul></li><li><a href="module-api_utils_utils.html">api/utils/utils</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_utils_utils.html#.decrypt">decrypt</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_utils.html#.encrypt">encrypt</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#APICallback">APICallback</a></li><li><a href="global.html#debounce">debounce</a></li><li><a href="global.html#IPC">IPC</a></li><li><a href="global.html#params">params</a></li><li><a href="global.html#passToMaster">passToMaster</a></li><li><a href="global.html#timeObject">timeObject</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">parts/jobs/resource.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';

const cp = require('child_process'),
	  EventEmitter = require('events'),
	  ipc = require('./ipc.js'),
	  JOB = require('./job.js'),
	  log = require('../../utils/log.js')('jobs:resource');

const CMD = {
	RUN: 'resource:run',
	ABORT: 'resource:abort',
	DONE: 'resource:done',
	OPENED: 'resource:opened',
	CLOSED: 'resource:closed',
	CRASH: 'resource:crash',
	TIMEOUT: 'resource:timeout',
	ONLINE: 'resource:online'
},
EVT = {
	ONLINE: 'online',
	OPENED: 'opened',
	CLOSED: 'closed',
	ABORT: 'abort',
	EXIT: 'exit',
	TIMEOUT: 'timeout',
	CRASH: 'crash',
},
RESOURCE_PING_INTERVAL = 10000,
RESOURCE_CLOSE_TIMEOUT = 360000,
RESOURCE_CMD_TIMEOUT = 15 * 60000;

function random() { 
	var s = Math.random().toString(36).slice(2); 
	return s; 
	// return s.length === 16 ? s : random(); 
}

/**
 * Base class for both: Resource &amp; ResourceFa√ßade which implements interface for talking to Job / JobFa√ßade &amp; Manager.
 */
class ResourceInterface extends EventEmitter {
	constructor(id, name) {
		super();
		this._online = false;
		this._open = null;
		this._job = null;
		this._id = id;
		this._name = name;
	}

	get isBusy() { return !!this._job; }
	get isOpen() { return !!this._open; }
	get id() { return this._id; }
	get name() { return this._name; }
	get job() { return this._job; }
	set job(job) { this._job = job; }

	run (/*job*/) {
		throw new Error('Resource.run must be overridden to return promise');
	}

	abort (/*job*/) {
		throw new Error('Resource.run must be overridden to return promise');
	}

	onceOnline () {
		if (this._online) {
			return Promise.resolve();
		} else {
			return new Promise((resolve) => {
				setTimeout(resolve.bind(null, false), 30000);
				this.once(EVT.ONLINE, () => {
					this._online = true;
					resolve(true);
				});
			});
		}
	}

	onceOpened () {
		if (this._open) {
			return Promise.resolve();
		} else if (!this._online) {
			return new Promise((resolve, reject) => {
				return this.onceOnline().then(() => {
					this.onceOpened().then(resolve, reject);
				}, reject);
			});
		} else {
			this.once(EVT.OPENED, () => {
				this._open = true;
			});
			return this.open();
		}
	}

	onceClosed () {
		if (!this._open) {
			return Promise.resolve();
		} else {
			this.once(EVT.CLOSED, () => {
				this._open = false;
			});
			return this.close();
		}
	}
}

/**
 * ResourceFa√ßade is a thin IPC fa√ßade for actual resource running in a separate process.
 * Constructor requires actual job instance just to instantiate a resource from its createResource call, separate run call is required to start it.
 */
class ResourceFa√ßade extends ResourceInterface {
	constructor(job, file) {
		super('res:' + job.resourceName() + ':' + random(), 'res:' + job.resourceName());
		this._file = file;
		this._worker = cp.fork(__dirname + '/executor.js', [JSON.stringify({
			_id: this.id, 
			name: this.name, 
			file: this._file,
			job: job._json
		})]);
		log.i('[fa√ßade]: Started resource %j in %d for %j: %j', this.name, process.pid, this._worker.pid, this.id);

		this.channel = new ipc.IdChannel(this.id);
		this.channel.attach(this._worker);
		
		this.channel.on(CMD.DONE, (json) => {
			if (json.error) {
				log.i('[fa√ßade]: Done running %s with error %j %j (%j) in %d', json._id, json.error, this.name, this.id, this._worker.pid);
				this.reject(json.error);
			} else {
				log.i('[fa√ßade]: Done running %s with success %j (%j) in %d', json._id, this.name, this.id, this._worker.pid);
				this.resolve(json);
			}
		});
		
		this.channel.on(CMD.ABORT, () => {
			this.reject(EVT.ABORT);
		});
		
		this.channel.on(CMD.OPENED, () => {
			log.i('[fa√ßade]: Resource %j opened in %d: %j', this.name, this._worker.pid, this.id);
			this._open = true;
			this.emit(EVT.OPENED);
		});
		
		this.channel.on(CMD.CLOSED, (err) => {
			log.i('[fa√ßade]: Resource %j closed in %d: %j', this.name, this._worker.pid, this.id, err);
			this._open = false;
			if (!this._crashed) {
				if (this._job) {
					log.i('[fa√ßade]: Resource %j closed in %d (%j) while running %s, will reject', this.name, this._worker.pid, this.id, this._job._idIpc, err);
					this.reject(err || EVT.CLOSED);
				}
				this.emit(EVT.CLOSED, err);
			}
		});

		this.channel.on('exit', () => {
			log.i('[fa√ßade]: Resource %j exited in %d: %j', this.name, this._worker.pid, this.id);
			if (!this._crashed) {
				this.emit(EVT.CLOSED);
				if (this._job) {
					log.i('[fa√ßade]: Resource %j exited in %d (%j) while running %s, will reject', this.name, this._worker.pid, this.id, this._job._idIpc);
					this.reject('Process exited');
				}
				this.emit(EVT.EXIT);
			}
		});

		this.channel.on(CMD.CRASH, (err) => {
			if (!this._crashed) {
				log.e('[fa√ßade]: Resource %s (%s) crashed in %d: %j', this.name, this.id, this._worker.pid, err);
				if (this.job) {
					this.reject([JOB.ERROR.CRASH, err]);
				} else {
					this.emit(EVT.CRASH);
				}
				this.close();
			}
		});

		this.channel.on(CMD.TIMEOUT, (err) => {
			if (!this._crashed) {
				log.e('[fa√ßade]: Resource %s (%s) timed out in %d: %j', this.name, this.id, this._worker.pid, err);
				if (this.job) {
					this.reject([JOB.ERROR.TIMEOUT, err]);
				} else {
					this.emit(EVT.TIMEOUT);
				}
				this.close();
			}
		});

		this.channel.on(CMD.ONLINE, () => {
			log.d('ResourceFa√ßade %s is online', this.id);
			this.emit(EVT.ONLINE);
		});
	}

	get isBusy() { return !!this._job; }
	get isReady() { return this.open === true || this.open === null; }

	run (job) {
		if (this.isBusy) { 
			log.w('[fa√ßade]: Resource fa√ßade %j is busy in %d: %j', this.name, this._worker.pid, this.id);
			return Promise.reject('busy'); 
		}
		this.job = job;
		log.i('[fa√ßade]: Resource fa√ßade %j in %d (%j) is going to run %s', this.name, this._worker.pid, this.id, job._idIpc);
		return new Promise((resolve, reject) => {
			this._resolve = resolve;
			this._reject = reject;

			this.onceOpened().then(this.channel.send.bind(this.channel, CMD.RUN, job._json), (e) => {
				log.e('Error in job resource fa√ßade .run() promise ', e, e.stack);
				this.close();
				reject(e);
			});
		});
	}

	close () {
		if (this.isOpen) {
			log.w('Closing underlying resource %s from fa√ßade', this.id);
			log.w('Stack %j', new Error().stack);
			return new Promise((resolve, reject) => {
				setTimeout(reject.bind(null, JOB.ERROR.TIMEOUT), RESOURCE_CMD_TIMEOUT);
				this.channel.once(CMD.CLOSED, () => {
					this.channel.remove();
					resolve();
				});
				this.channel.send(CMD.CLOSED);
			});
 		} else {
 			return Promise.resolve();
 		}
	}

	kill () {
		return new Promise((resolve) => {
			this._worker.kill();
			this._open = false;
			this._job = null;
			resolve();
		});
	}

	open () {
		if (this.isOpen) {
			return Promise.resolve();
		} else {
			log.w('Opening underlying resource %s from fa√ßade', this.id);
			return new Promise((resolve, reject) => {
				setTimeout(() => {
					reject(JOB.ERROR.TIMEOUT);
					this.close();
				}, RESOURCE_CMD_TIMEOUT);
				this.channel.send(CMD.OPENED);
				this.channel.once(CMD.OPENED, resolve);
				this.channel.once(CMD.CLOSED, reject);
			});
		}
	}

	abort (job) {
		if (!this.job) {
			log.w('[fa√ßade]: Resource fa√ßade %j is not open in %d: %j', this.name, this._worker.pid, this.id);
			return Promise.reject('no job is running to abort'); 
		}

		if (this.job._id !== job._id) {
			log.w('[fa√ßade]: Resource fa√ßade %j is not open in %d: %j', this.name, this._worker.pid, this.id);
			return Promise.reject('busy with job other than requested to abort'); 
		}

		this.channel.send(CMD.ABORT, job._json);
	}

	resolve () {
		if (this._resolve) {
			log.w('[fa√ßade]: Resolving %s', this.job._idIpc);
			this._resolve.apply(this, arguments);
			this.job.releaseResource(this).then(() => {
				log.i('[fa√ßade]: Released resource for %s', this.job._idIpc);
				this.job = null;
			}, err => {
				log.e('[fa√ßade]: Resource release returned error for %s: %j', this.job._idIpc, err);
				this.job = null;
			});
			this._resolve = this._reject = this.job.resource = null;
		} else {
			log.w('ResourceFa√ßade %s already returned, nothing to resolve', this.id);
		}
	}

	reject (error) {
		if (this._reject) {
			log.w('[fa√ßade]: Rejecting %s', this.job._idIpc);
			this._reject.apply(this, arguments);
			this.job.releaseResource(this).then(() => {
				log.i('[fa√ßade]: Released resource for %s', this.job._idIpc);
				this.job = null;
			}, err => {
				log.e('[fa√ßade]: Resource release returned error for %s: %j', this.job._idIpc, err);
				this.job = null;
			});
			this._resolve = this._reject = this.job.resource = null;
		} else {
			log.w('ResourceFa√ßade %s already returned, nothing to reject with %j', this.id, error);
		}
	}
}

class ResourcePool extends EventEmitter {
	constructor(construct, maxResources) {
		super();
		this.construct = construct;
		this.maxResources = maxResources;
		this.pool = [];
	}

	canRun () {
		for (let i = 0; i &lt; this.pool.length; i++) {
			if (!this.pool[i].isBusy) {
				return true;
			}
		}
		return this.pool.length &lt; this.maxResources;
	}

	getResource () {
		for (let i = 0; i &lt; this.pool.length; i++) {
			if (!this.pool[i].isBusy) {
				return this.pool[i];
			}
		}

		if (this.pool.length &lt; this.maxResources) {
			let resource = this.construct();
			resource.on(EVT.CLOSED, () => {
				let idx = this.pool.indexOf(resource);
				if (idx !== -1) { 
					log.d('[jobs]: Resource %j is closed, removing from pool', resource._id);
					this.pool.splice(idx, 1); 
					if (this.pool.length === 0) {
						this.emit(EVT.CLOSED);
					}
				}
			});
			this.pool.push(resource);
			return resource;
		}

		throw new Error('ResourcePool should be checked with canRun() before calling getResource()');
	}

	close () {
		return Promise.all(this.pool.map(r => r.close().catch(e => e.kill()))).catch((error) => {
			log.w('Error while closing pooled resources', error);
		});
	}

	kill () {
		return Promise.all(this.pool.map(r => r.kill())).catch((error) => {
			log.w('Error while killing pooled resources', error);
		});
	}
}

/**
 * Main class for custom resources to override.
 */
class Resource extends ResourceInterface {
	constructor(_id, name, checkInterval, autoCloseTimeout) {
		super(_id, name);
		this._resourceCheckMillis = checkInterval || RESOURCE_PING_INTERVAL;
		this._resourceAutoCloseMillis = autoCloseTimeout || RESOURCE_CLOSE_TIMEOUT;
	}

	opened () {
		this._open = true;
		log.i('[%d]: Opened resource %j (%j)', process.pid, this.name, this.id);
		this.emit(EVT.OPENED);
		this.channel.send(CMD.OPENED);
		this._checkInterval = setInterval(() => {
			log.i('[%d]: Checking resource %j (%j)', process.pid, this.name, this.id);
			this.checkActive().then((active) => {
				log.i('[%d]: Resource %j (%j) is ' + (active ? 'active' : 'inactive'), process.pid, this.name, this.id);
				if (!active) {
					this._open = false;
					this.close();
				}
			}, (error) => {
				log.e('[%d]: Couldn\'t check resource %j (%j): %j', process.pid, this.name, this.id, error);
				this.close();
			});
		}, this._resourceCheckMillis);
	}

	closed () {
		this._open = false;
		clearInterval(this._checkInterval);
		clearTimeout(this._closeTimeout);
		this.emit(EVT.CLOSED);
		this.channel.send(CMD.CLOSED);
		this.channel.remove();
		log.i('[%d]: Closed resource %j (%j), exiting', process.pid, this.name, this.id);
		setTimeout(() => {
			process.exit(0);
		}, 1000);
	}
	
	open () {
		throw new Error('Resource.open must be overridden to return a Promise which calls Resource.opened in case of success');
	}

	close () {
		throw new Error('Resource.open must be overridden to return a Promise which calls Resource.closed in case of success');
	}

	kill () {
		throw new Error('Resource.kill should not be ever called');
	}

	checkActive () {
		log.i('[%d]: Checking resource %j (%j)', process.pid, this.name, this.id);
	}

	start (channel, db, Constructor) {
		this.db = db;
		this.channel = channel;
		this.channel.on(CMD.RUN, (json) => {
			if (this.job) {
				log.e('[%d]: Resource is already running a job %j', process.pid, this.job._idIpc);
				throw new Error('Resource is already running a job');
			}

			this.job = new Constructor(json);
			this.job.resource = this;
		
			if (!(this.job instanceof JOB.IPCJob)) {
				throw new Error('Only IPCJob subclasses can be run on a resource');
			}

			clearTimeout(this._closeTimeout);

			log.i('[%d]: Running job %j (%j) in resource %j', process.pid, this.job.name, this.job._idIpc, this.id);
		
			this.onceOpened().then(() => {
				log.d('[%d]: Resource is open for %j', process.pid, this.job._idIpc);
				this.job.prepare(null, db).then(() => {
					this.job._run(this.db, this).then(this.done.bind(this, this.job, null), this.done.bind(this, this.job));
				}, this.done.bind(this, this.job))
			}, this.done.bind(this, this.job));
		});

		this.channel.on(CMD.CLOSED, () => {
			this.close();
		});

		this.channel.on(CMD.OPENED, () => {
			log.d('[%d]: Opening %s by command of fa√ßade', process.pid, this.id);
			this.open().then(() => {}, (err) => {
				this.channel.send(CMD.CLOSED, err);
				this.close();
			});
		});

		process.on('uncaughtException', (err) => {
			log.e('[%d]: Crash in resource %s (%s):', process.pid, this.name, this.id, err, err.stack);
			this.job._sendSave();
			this.channel.send(CMD.CRASH, `uncaughtException: ${err}`);
			setTimeout(this.close.bind(this), 1200);
		});

		this.channel.send(CMD.ONLINE);
		log.d('Resource is online');
	}

	done (job, error) {
		if (error === JOB.ERROR.TIMEOUT) {
			log.w('[%d]: Timeout for job %s (%s) in resource %s', process.pid, job.name, job._idIpc, this.id);
			this.job._sendSave();
			this.channel.send(CMD.TIMEOUT);
			setTimeout(this.close.bind(this), 1200);
		} else {
			log.i('[%d]: Done running job %j (%j) in resource %s', process.pid, job.name, job._idIpc, this.id);
			job._json.error = job._json.error || error;
			this.job.resource = this.job = null;
			this.channel.send(CMD.DONE, job._json);
			if (this._closeTimeout) {
				clearTimeout(this._closeTimeout);
			}
			this._closeTimeout = setTimeout(() => {
				log.i('[%d]: Auto-closing resource %s after %dms', process.pid, this.id, this._resourceAutoCloseMillis);
				this.close();
			}, this._resourceAutoCloseMillis);
		}
	}
}

module.exports = {
	CMD: CMD,
	EVT: EVT,
	Resource: Resource,
	ResourceFa√ßade: ResourceFa√ßade,
	ResourcePool: ResourcePool
};
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.3</a> on Mon Apr 09 2018 07:07:48 GMT+0000 (UTC) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/jquery-3.1.1.min.js"></script>

<script src="scripts/search.js"></script>


<script src="scripts/collapse.js"></script>



</body>
</html>
